# 层次分析法

## 评价类模型

#### 概念

多种方案择优。

#### 解决

解决评价类问题，须考虑以下三个问题：

① 评价目的是什么		

%题目给出

② 为达到这种目的有哪几种方案	

%题目给出

③ 评价准则和指标是什么*（ 根据什么来评价好坏 ？）	

%需要根据题目中的背景材料、常识以及网上收集到的参考资料进行结合，从而筛选最合适的指标

**最基本的打分法**

![评价类问题.打分表.png](https://i.loli.net/2020/03/28/dx8uZzbkTLhUFlo.png)

**同颜色的单元格和为1，它们表示针对某一因素所占的权值**

## 层次分析法

​	The analytic hierarchy process，简称AHP。

​	解决关于权值的确定问题*

> ​	在确定影响因素的诸因子在该因素中所占比重时，遇到的主要困难是这些比重常常不易定量化。此外，当影响某因素的因子较多时，直接考虑各因子对该因素有多大程度影响时，常常会因考虑不周全、顾此失彼而使决策者提出与他实际认为的重要性程度不相一致的数据，甚至有可能提出一组隐含矛盾的数据。
>
> ​																																	——《数学建模算法与运用》

​	问题：一次性考虑多个指标间关系，往往考虑不周。

​	解决方法：两个两个指标进行比较，最终经过两两比较结果。（权重分析法的基本思想）

### 标度的引入

例如：

| 标度    | 含义                                                         |
| ------- | ------------------------------------------------------------ |
| 1       | 表示两个因素相比，具有相同的重要性                           |
| 3       | 表示两个因素相比，一个因素比另一个因素   **稍微**  重要      |
| 5       | 表示两个因素相比，一个因素比另一个因素   **明显**  重要      |
| 7       | 表示两个因素相比，一个因素比另一个因素   **强烈**  重要      |
| 9       | 表示两个因素相比，一个因素比另一个因素   **极端**  重要      |
| 2,4,6,8 | 上列两个相邻判断中值（比如：2表示介于  **稍微**  与  **明显**  之间） |
| 倒数    | 若方案A与B相比标度为3，则B与A相比的标度就为1/3               |

![评价类问题.层次分析权重分析表.jpg](https://i.loli.net/2020/03/28/qSLdyOMYzFPHD64.jpg)

​		实际情况下，层次分析法中的这张表需要交给‘专家’填的。*

### 层次分析表的表示（判断矩阵）

得到完整的表格后，用**矩阵**的方式来表示表格。

例如下面这张表：

![评价类问题.层次分析法表格（满）.jpg](https://i.loli.net/2020/03/28/KPaHZlV7mexcFWp.jpg)

可得到5 × 5的方阵，这里记为A，对应元素记为a<sub>ij</sub>

这个方阵有以下特点：

* a<sub>ij</sub>表示的意义为，与指标j相比，i的重要程度，

* 当i=j时，两个指标相同，因此同等重要记为1，

* a<sub>ij</sub>>0且满足a<sub>ij</sub> × a<sub>ij</sub> =1（称这样的矩阵为<font color=skyblue>正互反矩阵</font>）

  

这样的矩阵在层次分析法中称为<font color="red">判断矩阵</font>。

同样，方案间也可以列判断矩阵:

![评价类问题.判断矩阵.png](https://i.loli.net/2020/03/28/4KfoeFvnPlkcd95.png)

### 一致矩阵的特点及定义

当然，判断矩阵中可能会出现一个这样的bug：

![评价类问题.层次分析法中的一个小bug.jpg](https://i.loli.net/2020/03/28/lCmb6kTEJhwefKx.jpg)

为了避免这样的bug产生，于是对判断矩阵进行如下定义：

​				a<sub>ij</sub>=i的重要程度/j的重要程度	a<sub>jk</sub>=j的重要程度/k的重要程度	

​									a<sub>ik</sub>=i的重要程度/k的重要程度=  a<sub>ij </sub> ×  a<sub>jk</sub>

**特点：**

* 各行（各列）之间成倍数关系。

* a<sub>ik</sub>=  a<sub>ij </sub> ×  a<sub>jk</sub>

  

**现在，给一致矩阵下定义：**

* 若矩阵中每个元素a<sub>ij </sub>＞0且满足a<sub>ij </sub> ×  a<sub>ji</sub>=1，则称为正互反矩阵。
* 在层次分析法中，所构造的矩阵均为正互反矩阵。
* 若正互反矩阵满足a<sub>ik</sub>=  a<sub>ij </sub> ×  a<sub>jk</sub>。

### 一致性检验概念引入

​	实际情况下，绝对的一致往往是不现实的，那么我们需要把不一致现象控制在一定程度。所以在使用判断矩阵求权重前，必须检查一致性。若矛盾过大的话，这个判断矩阵就失效了。

检验原理：

​	检验构造的判断矩阵和一致矩阵是否有太大差别。

推导：

![评价类问题.判断矩阵的一致性推导.png](https://i.loli.net/2020/03/28/itOTkPa8pzcsqg5.png)

引理：

​	n阶正互反矩阵A为一致矩阵时当且仅当最大特征值为λ<sub>max</sub>=n.

​	且当正互反矩阵A非一致性时,一定满足λ<sub>max</sub>＞n.

判断矩阵越不一致时,最大特征值与n相差就越大。

### 一致性检验步骤

第一步

​	计算一致性指标ＣＩ

​										ＣＩ＝（　λ<sub>max</sub>－ｎ　）／（ｎ－１）

第二步

​	查找对应平均一致性指标ＲＩ

​    RI的值是用随机的方法构造500个样本矩阵：随机地从1~9及其倒数中抽取数字构造正互反矩阵，求得最大的特征根的平均值λ‘<sub>max</sub>，并定义

​									  	RＩ＝（　λ'<sub>max</sub>－ｎ　）／（ｎ－１）

第三步

​	计算一致性比例ＣＲ

​											ＣＲ＝	ＣＩ／ＲＩ

**ＣＲ表示相差程度，若ＣＲ＜０.１，则可认为判断矩阵一致性可以接受；否则需要对矩阵进行修正。**（0.1是由多次蒙特卡罗模拟得到的最佳方案。)

![评价类问题.一致性检验步骤.png](https://i.loli.net/2020/03/28/bZrSN2KfYEd4cgI.png)

### 一致性矩阵推算出权重

* 方法一：算术平均法求权重

  * 第一步

    ​	将判断矩阵进行归一化（每个元素除以其所在列的和）。

  * 第二步

    ​	将归一化的各列相加（按行求和），再除以n得到权重向量。

  * 数学符号表示

    ![评价类问题.求权重方法一.jpg](https://i.loli.net/2020/03/28/GdzVyuHiPCAcl7t.jpg)

* 方法二：几何平均法

  ![评价类问题.方法二几何.jpg](https://i.loli.net/2020/03/28/sm21DBqunLJr9Ho.jpg)

* 方法三：特征值求权重**

  用最大特征值对应的特征向量（就是第一列的元素）代表它的权重。

  * 第一步

    ​	求出矩阵Ａ的最大特征值以及其对应的特征向量

  * 第二步

    ​	对求出的特征向量进行归一化处理得到权重

### 总结

第一步（画出层次分析法结构图）：

评价类问题首先得想到一下三个问题：

目标；方案；准则；

![评价类问题.层次分析法结构图.png](https://i.loli.net/2020/03/03/HnNdTopDrjEZl4g.png)

若用到层次分析法，则一定要将图放在论文中。

第二步（构造判断矩阵）：

对于同一层次的个元素关于上一层次中某一准则的重要性进行两两比较

![评价类问题.判断矩阵.png](https://i.loli.net/2020/03/03/uDRNSZvBFIhWjOi.png)

这个判断矩阵命名为O-C

第三步（由判断矩阵计算被比较元素对应准则的相对权重，并进行一致性检验）：

三种方法计算权重：1）算术平均法；2）几何平均法；3）特征值法；

为了保证结果的稳健性，需要用三个方法分别求出权重。

![一致性检验步骤.jpg](https://i.loli.net/2020/07/02/VdozetCg56pJZD2.jpg)

### 层次分析法的局限性

1）.评价的决策层不能太多，太多的话n很大，判断矩阵和决策性矩阵的差距会很大。

2）.如果决策层中指标的数据是已知的，那么如何利用这些数据使得评价更准确呢。

## 代码（matlab）



##### 判断是否为正负反矩阵：

```matlab
disp('请输入判断矩阵A')     
A=input('A=');     
ERROR = 0;  
[r,c]=size(A);
if r ~= c  || r <= 1
    ERROR = 1;
end
if ERROR == 0
    [n,n] = size(A);
    if sum(sum(A <= 0)) > 0
        ERROR = 2;
    end
end
if ERROR == 0
    if n > 15
        ERROR = 3;
    end
end
if ERROR == 0
    if sum(sum(A' .* A ~=  ones(n))) > 0
        ERROR = 4;
    end
end

if ERROR == 0
```



##### 矩阵一致性检验

```matlab
%%计算一致性比例CR
clc
CI=(Max_eig-n)/(n-1);%这里Max_eig为特征值法求权重
RI=[0 0 0.52 0.89 1.12 1.26 1.36 1.41 1.46 1.49 1.52 1.54 1.56 1.58 1.59];%这里的RI最多支持n=15
CR=CI/RI(n);
disp('一致性指标CI=');disp(CI);
disp('一致性指标CR=');disp(CR);%CR为一致性比例
if CR<0.10
	disp('因为CR<0.1,所以该判断矩阵A的一致性可以接受');
else
	disp('CR>=0.1,因此该判断矩阵需要修改');
end
```

ps：若矩阵为二阶矩阵，则运行结果一定是一致的，造成结果出错

修改：

```matlab

clc
CI=(Max_eig-n)/(n-1);
RI=[0 0.001 0.52 0.89 1.12 1.26 1.36 1.41 1.46 1.49 1.52 1.54 1.56 1.58 1.59];
%把第二个数改成比较小的数
CR=CI/RI(n);
disp('一致性指标CI=');disp(CI);
disp('一致性指标CR=');disp(CR);
if CR<0.10
	disp('因为CR<0.1,所以该判断矩阵A的一致性可以接受');
else
	disp('CR>=0.1,因此该判断矩阵需要修改');
end
```



##### 算术平均法

```matlab
%%输入判断矩阵（各行各列成倍数关系）
clear;clc;
disp('输入判断矩阵A：')
A=[1 1 4 1/3 3;
   1 1 4 1/3 3;
   1/4 1/4 1 1/3 1/2;
   3 3 3 1 3;
   1/3 1/3 2 1/3 1]
   
%%%第一步，将判断矩阵归一化（每个元素除以其所在列的和）
A_sum=sum(A,1)%按照列来求和
n=size(A,1)%因为是方正所以直接求A列长度
A_SUM=repmat(A_sum,n,1)%A_Sum矩阵按照行重复n次
A_SUM
Stand_A=A./A_SUM%点除，对应位置元素相除

%%%第二步，将归一化各列相加
sum(Stand_A,2)%按行求和

%%% 第三步，将相加后的向量中每一个元素除以n即可得到权向量
disp('算术平均法求权重的结果为：');
disp(sum(Stand_A,2)/n)
```

##### 几何平均法

```matlab
clc;A
%%%第一步：将A的元素按照行相乘得到一个新的列向量
Prduct_A=prod(A,2)%prod和sum相似，但prod是相乘
%%%第二步：将新的向量每个分量开n次方
Prduct_n_A=Prduct_A.^(1/n)
%%%第三步，对该列向量进行归一化即可得到权重向量
%%%%将这个向量的每一个元素除以这个向量的和即可
disp('几何平均法求权重的结果：');
disp(Prduct_n_A./sum(Prduct_n_A))
```

##### 特征值法求权重

```matlab
%第一步：求矩阵A的最大特征值以及对应的特征向量
clc
[V,D]=eig(A)%D为特征值，V为特征向量
Max_eig=max(max(D))%需要用到find函数，它可以返回向量不为0的元素位置的索引
D==Max_eig
[r,c]=find(D==Max_eig,1)%找到D中一个与最大特征值相等的元素位置，记录它的行和列
%第二步，对求出的向量进行归一化
disp('特征值法求权重结果为：')
disp(V(:,c)./sum(V(:,c)))
```

##### 完整代码

```matlab
disp('请输入判断矩阵A')     
A=input('A=');     
ERROR = 0;  
[r,c]=size(A);
if r ~= c  || r <= 1
    ERROR = 1;
end
if ERROR == 0
    [n,n] = size(A);
    if sum(sum(A <= 0)) > 0
        ERROR = 2;
    end
end
if ERROR == 0
    if n > 15
        ERROR = 3;
    end
end
if ERROR == 0
    if sum(sum(A' .* A ~=  ones(n))) > 0
        ERROR = 4;
    end
end

if ERROR == 0
    % % % % % % % % % % % % %方法1： 算术平均法求权重% % % % % % % % % % % % %
    Sum_A = sum(A);
    SUM_A = repmat(Sum_A,n,1);
    Stand_A = A ./ SUM_A;
    disp('算术平均法求权重的结果为：');
    disp(sum(Stand_A,2)./n)
    % % % % % % % % % % % % %方法2： 几何平均法求权重% % % % % % % % % % % % %
    Prduct_A = prod(A,2);
    Prduct_n_A = Prduct_A .^ (1/n);
    disp('几何平均法求权重的结果为：');
    disp(Prduct_n_A ./ sum(Prduct_n_A))
    % % % % % % % % % % % % %方法3： 特征值法求权重% % % % % % % % % % % % %
    [V,D] = eig(A);
    Max_eig = max(max(D));
    [r,c]=find(D == Max_eig , 1);
    disp('特征值法求权重的结果为：');
    disp( V(:,c) ./ sum(V(:,c)) )
    % % % % % % % % % % % % %下面是计算一致性比例CR的环节% % % % % % % % % % % % %
    CI = (Max_eig - n) / (n-1);
    RI=[0 0.00001 0.52 0.89 1.12 1.26 1.36 1.41 1.46 1.49 1.52 1.54 1.56 1.58 1.59];  %注意哦，这里的RI最多支持 n = 15
    % 这里n=2时，一定是一致矩阵，所以CI = 0，我们为了避免分母为0，将这里的第二个元素改为了很接近0的正数
    CR=CI/RI(n);
    disp('一致性指标CI=');disp(CI);
    disp('一致性比例CR=');disp(CR);
    if CR<0.10
        disp('因为CR<0.10，所以该判断矩阵A的一致性可以接受!');
    else
        disp('注意：CR >= 0.10，因此该判断矩阵A需要进行修改!');
    end
elseif ERROR == 1
    disp('请检查矩阵A的维数是否不大于1或不是方阵')
elseif ERROR == 2
    disp('请检查矩阵A中有元素小于等于0')
elseif ERROR == 3
    disp('A的维数n超过了15，请减少准则层的数量')
elseif ERROR == 4
    disp('请检查矩阵A中存在i、j不满足A_ij * A_ji = 1')
end
```

